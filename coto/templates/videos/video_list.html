{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Мои видео" %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/videos.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h2 mb-0">
          <i class="bi bi-collection-play me-2"></i>
          {% trans "Мои видео" %}
        </h1>
        <a href="{% url 'upload:orientation' %}" class="btn btn-primary">
          <i class="bi bi-cloud-upload me-2"></i>
          {% trans "Загрузить новое видео" %}
        </a>
      </div>
      
      <!-- Статистика -->
      <div class="card mb-4 stats-card">
        <div class="card-body">
          <div class="row text-center">
            <div class="col-md-3">
              <div class="stat-item">
                <i class="bi bi-collection-play stat-icon"></i>
                <h3 class="mb-0">{{ total_videos }}</h3>
                <p class="text-muted mb-0">{% trans "Всего видео" %}</p>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <i class="bi bi-check-circle stat-icon text-success"></i>
                <h3 class="mb-0">{{ videos|length }}</h3>
                <p class="text-muted mb-0">{% trans "На странице" %}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Поиск и фильтры -->
      <div class="card mb-4 filter-card">
        <div class="card-body">
          <form method="get" class="row g-3">
            <div class="col-md-4">
              <label for="search" class="form-label">
                <i class="bi bi-search me-1"></i>
                {% trans "Поиск" %}
              </label>
              <input 
                type="text" 
                class="form-control" 
                id="search" 
                name="q" 
                value="{{ search_query }}"
                placeholder="{% trans 'Поиск по названию или описанию' %}"
              >
            </div>
            
            <div class="col-md-3">
              <label for="status" class="form-label">
                <i class="bi bi-funnel me-1"></i>
                {% trans "Статус обработки" %}
              </label>
              <select class="form-select" id="status" name="status">
                <option value="">{% trans "Все статусы" %}</option>
                {% for value, label in available_statuses %}
                  <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
            </div>
            
            <div class="col-md-3">
              <label for="sort" class="form-label">
                <i class="bi bi-sort-down me-1"></i>
                {% trans "Сортировка" %}
              </label>
              <select class="form-select" id="sort" name="sort">
                <option value="-created_at" {% if sort_by == "-created_at" %}selected{% endif %}>
                  {% trans "Новые первые" %}
                </option>
                <option value="created_at" {% if sort_by == "created_at" %}selected{% endif %}>
                  {% trans "Старые первые" %}
                </option>
                <option value="title" {% if sort_by == "title" %}selected{% endif %}>
                  {% trans "По названию (А-Я)" %}
                </option>
                <option value="-title" {% if sort_by == "-title" %}selected{% endif %}>
                  {% trans "По названию (Я-А)" %}
                </option>
                <option value="-hls_progress" {% if sort_by == "-hls_progress" %}selected{% endif %}>
                  {% trans "По прогрессу (↓)" %}
                </option>
              </select>
            </div>
            
            <div class="col-md-2 d-flex align-items-end">
              <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-funnel-fill me-1"></i>
                {% trans "Применить" %}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Список видео -->
  {% if videos %}
  <div class="row g-4">
    {% for video in videos %}
    <div class="col-md-6 col-lg-4">
      <div class="card video-card h-100">
        <div class="card-img-wrapper">
          {% if video.thumbnail %}
            <img src="{{ video.thumbnail.url }}" class="card-img-top" alt="{{ video.title }}">
          {% else %}
            <div class="card-img-placeholder">
              <i class="bi bi-film"></i>
            </div>
          {% endif %}
          
          <!-- Статус badge -->
          <span class="status-badge status-{{ video.hls_status|slugify }}">
            {% if video.hls_status == "done" or video.hls_status == "completed" %}
              <i class="bi bi-check-circle-fill"></i> {% trans "Готово" %}
            {% elif video.hls_status == "processing" or video.hls_status == "pending" %}
              <i class="bi bi-hourglass-split"></i> {% trans "Обработка" %}
            {% elif video.hls_status == "failed" or video.hls_status == "error" %}
              <i class="bi bi-x-circle-fill"></i> {% trans "Ошибка" %}
            {% else %}
              <i class="bi bi-clock"></i> {% trans "Ожидание" %}
            {% endif %}
          </span>
        </div>
        
        <div class="card-body">
          <h5 class="card-title">{{ video.title }}</h5>
          <p class="card-text text-muted small">
            {{ video.description|truncatewords:15 }}
          </p>
          
          <!-- Прогресс обработки HLS -->
          {% if video.hls_status != "done" and video.hls_status != "completed" and video.hls_progress > 0 %}
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <small class="text-muted">{% trans "Прогресс обработки" %}</small>
              <small class="text-muted">{{ video.hls_progress }}%</small>
            </div>
            <div class="progress" style="height: 8px;">
              <div 
                class="progress-bar progress-bar-striped progress-bar-animated" 
                role="progressbar" 
                style="width: {{ video.hls_progress }}%;"
                aria-valuenow="{{ video.hls_progress }}" 
                aria-valuemin="0" 
                aria-valuemax="100"
              ></div>
            </div>
          </div>
          {% endif %}
          
          <div class="d-flex justify-content-between align-items-center text-muted small mb-3">
            <span>
              <i class="bi bi-calendar3"></i>
              {{ video.created_at|date:"d.m.Y H:i" }}
            </span>
            {% if video.duration %}
            <span>
              <i class="bi bi-clock"></i>
              {{ video.duration }}
            </span>
            {% endif %}
          </div>
        </div>
        
        <div class="card-footer bg-transparent">
          <div class="btn-group w-100" role="group">
            <a href="{% url 'videos:detail' video.pk %}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-eye"></i> {% trans "Просмотр" %}
            </a>
            <a href="{% url 'videos:edit' video.pk %}" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-pencil"></i> {% trans "Редактировать" %}
            </a>
            <a href="{% url 'videos:delete' video.pk %}" class="btn btn-outline-danger btn-sm">
              <i class="bi bi-trash"></i> {% trans "Удалить" %}
            </a>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Пагинация -->
  {% if is_paginated %}
  <nav aria-label="Page navigation" class="mt-5">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
          <i class="bi bi-chevron-double-left"></i>
        </a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
          <i class="bi bi-chevron-left"></i>
        </a>
      </li>
      {% endif %}
      
      <li class="page-item active">
        <span class="page-link">
          {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}
        </span>
      </li>
      
      {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
          <i class="bi bi-chevron-right"></i>
        </a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&q={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">
          <i class="bi bi-chevron-double-right"></i>
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}

  {% else %}
  <!-- Пустое состояние -->
  <div class="row">
    <div class="col-12">
      <div class="empty-state text-center py-5">
        <i class="bi bi-film empty-state-icon"></i>
        <h3 class="mt-4">{% trans "Видео не найдено" %}</h3>
        <p class="text-muted">
          {% if search_query or status_filter %}
            {% trans "Попробуйте изменить параметры поиска или фильтрации" %}
          {% else %}
            {% trans "У вас пока нет загруженных видео" %}
          {% endif %}
        </p>
        <a href="{% url 'upload:orientation' %}" class="btn btn-primary mt-3">
          <i class="bi bi-cloud-upload me-2"></i>
          {% trans "Загрузить первое видео" %}
        </a>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
