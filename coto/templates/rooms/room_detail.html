{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <div class="room-header text-center">
    <h1 class="display-5">{{ room.name }}</h1>
    <p class="text-muted">
      Организатор: <strong>{{ room.host.username }}</strong> |
      Участников: <strong>{{ room.participants.count }} / {{ room.limit_participants }}</strong>
    </p>
  </div>

  <div class="row">
    <div class="col-lg-8 mb-4">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div class="video-wrapper">
            <video
              id="hls-player"
              class="video-js vjs-default-skin vjs-big-play-centered vjs-fluid"
              controls
              preload="auto"
              width="100%"
              height="400"
              data-room-id="{{ room.pk }}"
              data-is-host="{% if user == room.host %}true{% else %}false{% endif %}"
              data-hls-url="{{ room.video.hls_manifest.url }}"
            >
              <source src="{{ room.video.hls_manifest.url }}" type="application/x-mpegURL" />
              <p class="vjs-no-js">
                Для просмотра видео включите JavaScript и обновите браузер до
                <a href="https://videojs.com/html5-video-support/" target="_blank">версии с поддержкой HTML5</a>.
              </p>
            </video>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4 mb-6" id="chat-container" data-room-id="{{ room.pk }}">
      <div class="card shadow-sm" style="height: 480px; display: flex; flex-direction: column;">
        <div class="card-header"><strong>Чат</strong></div>
        <div class="card-body chat-box flex-grow-1 overflow-auto" id="chat-messages" style="display: flex; flex-direction: column; gap: 8px;">
          <!-- Сообщения сюда -->
        </div>
        <div class="card-footer">
          <form id="chat-form" class="d-flex">
            <input type="text" id="chat-input" class="form-control me-2" placeholder="Введите сообщение..." autocomplete="off">
            <button class="btn btn-primary" type="submit">Отправить</button>
          </form>
        </div>
      </div>
    </div>
   </div>

  <div class="card shadow-sm mt-3">
    <div class="card-header"><strong>Участники</strong></div>
    <div class="card-body" style="max-height: 200px; overflow-y: auto;">
      <ul id="participants-list" class="list-unstyled mb-0"></ul>
    </div>
  </div>

      <div class="d-grid gap-2 mt-2">
        {% if user.is_authenticated %}
          {% if user in room.participants.all %}
            <form method="post" action="{% url 'rooms:leave' room.pk %}">
              {% csrf_token %}
              <button class="btn btn-outline-danger btn-lg" type="submit">Отключиться</button>
            </form>
          {% else %}
            <form method="post" action="{% url 'rooms:join' room.pk %}">
              {% csrf_token %}
              <button class="btn btn-primary btn-lg" type="submit">Подключиться</button>
            </form>
          {% endif %}
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-secondary btn-lg">Войдите, чтобы подключиться</a>
        {% endif %}
        <a href="{% url 'rooms:list' %}" class="btn btn-light btn-lg">Назад к списку комнат</a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
  <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@videojs/http-streaming@3.10.0/dist/videojs-http-streaming.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-quality-levels@4.0.0/dist/videojs-contrib-quality-levels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-hls-quality-selector@1.1.4/dist/videojs-hls-quality-selector.min.js"></script>

  <link rel="stylesheet" href="{% static 'css/video.css' %}">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
  <script src="{% static 'js/sync_player.js' %}"></script>
  <script src="{% static 'js/Video.js' %}"></script>
  <script src="{% static 'js/chat.js' %}"></script>
  <script>window.currentUser = "{{ user.username }}";</script>

{% endblock %}
