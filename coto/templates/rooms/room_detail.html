{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <div class="room-header text-center">
    <h1 class="display-5">{{ room.name }}</h1>
    <p class="text-muted">
      –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä: <strong>{{ room.host.username }}</strong> |
      –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <strong id="participants-count">{{ room.participants.count }}</strong><strong> / {{ room.limit_participants }}</strong>
    </p>
  </div>

  <div class="row">
    <div class="col-lg-8 mb-4">
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <div class="video-wrapper">
            <video
              id="hls-player"
              class="video-js vjs-default-skin vjs-big-play-centered vjs-fluid"
              controls
              preload="auto"
              width="100%"
              height="400"
              data-room-id="{{ room.pk }}"
              data-is-host="{% if user == room.host %}true{% else %}false{% endif %}"
              data-hls-url="{{ room.video.hls_manifest.url }}"
            >
              <source src="{{ room.video.hls_manifest.url }}" type="application/x-mpegURL" />
              <p class="vjs-no-js">
                –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∏–¥–µ–æ –≤–∫–ª—é—á–∏—Ç–µ JavaScript –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–æ
                <a href="https://videojs.com/html5-video-support/" target="_blank">–≤–µ—Ä—Å–∏–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π HTML5</a>.
              </p>
            </video>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4 mb-6" id="chat-container" data-room-id="{{ room.pk }}">
      <div class="card shadow-sm h-100">
        
        <!-- Tabs -->
        <div class="card-header p-0">
          <ul class="nav nav-tabs nav-fill" id="room-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-pane" type="button" role="tab" aria-controls="chat-pane" aria-selected="true">
                üí¨ –ß–∞—Ç
              </button>
            </li>
            {% if room.playlist %}
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="playlist-tab" data-bs-toggle="tab" data-bs-target="#playlist-pane" type="button" role="tab" aria-controls="playlist-pane" aria-selected="false">
                üì∫ –ü–ª–µ–π–ª–∏—Å—Ç
              </button>
            </li>
            {% endif %}
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="participants-tab" data-bs-toggle="tab" data-bs-target="#participants-pane" type="button" role="tab" aria-controls="participants-pane" aria-selected="false">
                üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ (<span id="participants-count">{{ room.participants.count }}</span>/<span>{{ room.limit_participants }}</span>)
              </button>
            </li>
          </ul>
        </div>
    
        <!-- Tabs content -->
        <div class="tab-content flex-grow-1" style="height: 430px; display: flex; flex-direction: column;">
          
          <!-- Chat -->
          <div class="tab-pane fade show active h-100 d-flex flex-column" id="chat-pane" role="tabpanel" aria-labelledby="chat-tab">
            <div class="card-body chat-box flex-grow-1 overflow-auto p-3" id="chat-messages" style="display:flex; flex-direction:column; gap:8px;">
              <!-- –°–æ–æ–±—â–µ–Ω–∏—è —Å—é–¥–∞ -->
            </div>
            <div class="card-footer p-2">
              <form id="chat-form" class="d-flex" autocomplete="off">
                <input type="text" id="chat-input" class="form-control me-2" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
                <button class="btn btn-primary" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
              </form>
            </div>
          </div>
    
          {% if room.playlist %}
          <div class="tab-pane fade h-100 overflow-auto p-3" id="playlist-pane" role="tabpanel" aria-labelledby="playlist-tab">
          
            <!-- –ú–µ—Å—Ç–æ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—É—â–µ–π —Å–µ—Ä–∏–∏ -->
            <div id="current-episode" class="mb-3 p-2 bg-light border rounded fw-bold">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–∏–∏...</div>
          
            {% for item in room.playlist.items.all %}
              <div
                class="d-flex align-items-center mb-3 playlist-item border rounded p-2"
                data-hls-url="{{ item.video.hls_manifest.url }}"
                data-video-id="{{ item.video.id }}"
                data-season="{{ item.season_number }}"
                data-episode="{{ item.episode_number }}"
                data-title="{{ item.video.title }}"
              >
                {% if item.video.thumbnail %}
                  <img src="{{ item.video.thumbnail.url }}" alt="" class="me-3 rounded" style="width:80px; height:45px; object-fit:cover;">
                {% else %}
                  <div class="bg-secondary me-3 rounded" style="width:80px; height:45px;"></div>
                {% endif %}
                <div class="flex-grow-1">
                  <div class="fw-bold text-truncate">–°–µ–∑–æ–Ω {{ item.season_number }}, –°–µ—Ä–∏—è {{ item.episode_number }}</div>
                  <div class="text-muted small text-truncate">{{ item.video.title }}</div>
                </div>
                <div class="text-muted small ms-2">‚ñ∂</div>
              </div>
              {% empty %}
                <p class="text-muted">–ü–ª–µ–π–ª–∏—Å—Ç –ø—É—Å—Ç</p>
            {% endfor %}
          </div>
          {% endif %}
          
    
          <!-- Participants -->
          <div class="tab-pane fade h-100 overflow-auto p-3" id="participants-pane" role="tabpanel" aria-labelledby="participants-tab">
            <ul id="participants-list" class="list-unstyled mb-0"></ul>
          </div>
        </div>
      </div>
    </div>

    
  
      <div class="d-grid gap-2 mt-2">
        {% if user.is_authenticated %}
          {% if user in room.participants.all %}
            <form method="post" action="{% url 'rooms:leave' room.pk %}">
              {% csrf_token %}
              <button class="btn btn-outline-danger btn-lg" type="submit">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </form>
          {% else %}
            <form method="post" action="{% url 'rooms:join' room.pk %}">
              {% csrf_token %}
              <button class="btn btn-primary btn-lg" type="submit">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </form>
          {% endif %}
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-secondary btn-lg">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</a>
        {% endif %}
        <a href="{% url 'rooms:list' %}" class="btn btn-light btn-lg">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –∫–æ–º–Ω–∞—Ç</a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
  <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@videojs/http-streaming@3.10.0/dist/videojs-http-streaming.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-quality-levels@4.0.0/dist/videojs-contrib-quality-levels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-hls-quality-selector@1.1.4/dist/videojs-hls-quality-selector.min.js"></script>

  <link rel="stylesheet" href="{% static 'css/video.css' %}">
  <link rel="stylesheet" href="{% static 'css/chat.css' %}">
  <script src="{% static 'js/sync_player.js' %}"></script>
  <script src="{% static 'js/Video.js' %}"></script>
  <script src="{% static 'js/chat.js' %}"></script>
  <script src="{% static 'js/playlists.js' %}"></script>
  <script>window.currentUser = "{{ user.username }}";</script>

{% endblock %}
