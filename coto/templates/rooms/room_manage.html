{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="container py-4">
    <!-- Page Header -->
    <div class="text-center mb-5 fade-in">
        <h1 class="display-4 fw-bold mb-2">
            <i class="bi bi-sliders me-2"></i>
            {% trans "Управление комнатами" %}
        </h1>
        <p class="text-muted lead">{% trans "Ваши комнаты для совместного просмотра" %}</p>
        
        <div class="mt-4">
            <a href="{% url 'rooms:create' %}" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle me-2"></i>
                {% trans "Создать новую комнату" %}
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs nav-fill mb-4" id="roomTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="my-rooms-tab" data-bs-toggle="tab" 
                    data-bs-target="#my-rooms" type="button" role="tab">
                <i class="bi bi-house-door me-2"></i>
                {% trans "Мои комнаты" %}
                <span class="badge bg-primary ms-2">{{ hosted_rooms.count }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="joined-rooms-tab" data-bs-toggle="tab" 
                    data-bs-target="#joined-rooms" type="button" role="tab">
                <i class="bi bi-people me-2"></i>
                {% trans "Участвую" %}
                <span class="badge bg-success ms-2">{{ joined_rooms.count }}</span>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="roomTabsContent">
        <!-- My Rooms Tab -->
        <div class="tab-pane fade show active" id="my-rooms" role="tabpanel">
            {% if hosted_rooms %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for room in hosted_rooms %}
                <div class="col fade-in" style="animation-delay: {{ forloop.counter0|add:'0' }}s;">
                    <div class="card h-100 room-card">
                        <!-- Room Image -->
                        <div class="position-relative overflow-hidden" style="height: 200px;">
                            {% if room.room_image %}
                            <img src="{{ room.room_image.url }}" class="card-img-top w-100 h-100" 
                                 alt="{{ room.name }}" style="object-fit: cover;">
                            {% else %}
                            <img src="{% static 'images/default-room.jpg' %}" 
                                 class="card-img-top w-100 h-100" alt="По умолчанию" 
                                 style="object-fit: cover;">
                            {% endif %}
                            
                            <!-- Status Badges -->
                            <div class="position-absolute top-0 end-0 m-2">
                                {% if room.is_private %}
                                <span class="badge bg-warning text-dark me-1">
                                    <i class="bi bi-lock-fill"></i>
                                </span>
                                {% endif %}
                                <span class="badge bg-dark bg-opacity-75">
                                    <i class="bi bi-people-fill me-1"></i>
                                    {{ room.participants.count }}/{{ room.limit_participants }}
                                </span>
                            </div>
                        </div>

                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold mb-2">{{ room.name }}</h5>
                            
                            <div class="mb-3 flex-grow-1">
                                <p class="card-text mb-2">
                                    <i class="bi bi-film me-2 text-primary"></i>
                                    {% if room.video %}
                                    <strong>{{ room.video.title }}</strong>
                                    {% elif room.playlist %}
                                    <strong>{{ room.playlist.title }}</strong>
                                    <span class="badge bg-info ms-1">Плейлист</span>
                                    {% endif %}
                                </p>
                                <p class="card-text text-muted small mb-1">
                                    <i class="bi bi-calendar me-2"></i>
                                    {{ room.created_at|date:"d.m.Y H:i" }}
                                </p>
                                {% if room.is_private and room.access_code %}
                                <p class="card-text small mb-0">
                                    <i class="bi bi-key me-2 text-warning"></i>
                                    <span class="font-monospace fw-bold">{{ room.access_code }}</span>
                                </p>
                                {% endif %}
                            </div>

                            <!-- Management Buttons -->
                            <div class="d-grid gap-2">
                                <a href="{% url 'rooms:detail' room.pk %}" 
                                   class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-arrow-right-circle me-1"></i>
                                    {% trans "Открыть" %}
                                </a>
                                <div class="btn-group" role="group">
                                    <a href="{% url 'rooms:update' room.pk %}" 
                                       class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-pencil"></i>
                                        {% trans "Изменить" %}
                                    </a>
                                    <a href="{% url 'rooms:delete' room.pk %}" 
                                       class="btn btn-outline-danger btn-sm">
                                        <i class="bi bi-trash"></i>
                                        {% trans "Удалить" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                <div>
                    <h5 class="alert-heading mb-2">{% trans "У вас пока нет комнат" %}</h5>
                    <p class="mb-3">{% trans "Создайте свою первую комнату для совместного просмотра!" %}</p>
                    <a href="{% url 'rooms:create' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>
                        {% trans "Создать комнату" %}
                    </a>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Joined Rooms Tab -->
        <div class="tab-pane fade" id="joined-rooms" role="tabpanel">
            {% if joined_rooms %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for room in joined_rooms %}
                <div class="col fade-in" style="animation-delay: {{ forloop.counter0|add:'0' }}s;">
                    <div class="card h-100 room-card">
                        <!-- Room Image -->
                        <div class="position-relative overflow-hidden" style="height: 200px;">
                            {% if room.room_image %}
                            <img src="{{ room.room_image.url }}" class="card-img-top w-100 h-100" 
                                 alt="{{ room.name }}" style="object-fit: cover;">
                            {% else %}
                            <img src="{% static 'images/default-room.jpg' %}" 
                                 class="card-img-top w-100 h-100" alt="По умолчанию" 
                                 style="object-fit: cover;">
                            {% endif %}
                            
                            <div class="position-absolute top-0 end-0 m-2">
                                <span class="badge bg-dark bg-opacity-75">
                                    <i class="bi bi-people-fill me-1"></i>
                                    {{ room.participants.count }}/{{ room.limit_participants }}
                                </span>
                            </div>
                        </div>

                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title fw-bold mb-2">{{ room.name }}</h5>
                            
                            <div class="mb-3 flex-grow-1">
                                <p class="card-text mb-2">
                                    <i class="bi bi-film me-2 text-primary"></i>
                                    {% if room.video %}
                                    <strong>{{ room.video.title }}</strong>
                                    {% elif room.playlist %}
                                    <strong>{{ room.playlist.title }}</strong>
                                    <span class="badge bg-info ms-1">Плейлист</span>
                                    {% endif %}
                                </p>
                                <p class="card-text text-muted small">
                                    <i class="bi bi-person-circle me-2"></i>
                                    Организатор: <strong>{{ room.host.username }}</strong>
                                </p>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <a href="{% url 'rooms:detail' room.pk %}" 
                                   class="btn btn-primary btn-sm">
                                    <i class="bi bi-arrow-right-circle me-1"></i>
                                    {% trans "Открыть комнату" %}
                                </a>
                                <form method="post" action="{% url 'rooms:leave' room.pk %}">
                                    {% csrf_token %}
                                    <button class="btn btn-outline-danger btn-sm w-100" type="submit">
                                        <i class="bi bi-box-arrow-right me-1"></i>
                                        {% trans "Покинуть" %}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle-fill me-2 fs-4"></i>
                <div>
                    <h5 class="alert-heading mb-2">{% trans "Вы не участвуете ни в одной комнате" %}</h5>
                    <p class="mb-3">{% trans "Присоединитесь к существующей комнате или создайте свою!" %}</p>
                    <a href="{% url 'rooms:list' %}" class="btn btn-primary">
                        <i class="bi bi-door-open me-2"></i>
                        {% trans "Смотреть все комнаты" %}
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn 0.5s ease forwards;
}

.room-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.room-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg) !important;
}

.nav-tabs .nav-link {
    transition: all 0.3s ease;
}

.nav-tabs .nav-link:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}
